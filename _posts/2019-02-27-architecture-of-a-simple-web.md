---
layout: post
title:  "简单的 Web 应用架构概览"
date:   2019-02-27 20:31:19 +0800
---

一个 Web 应用通过功能分割，可以分为不同组件。本文以一个 Rails 应用为例，列出各个组件。

### 负载均衡：Nginx

使用 Nginx 作为负载均衡服务，Nginx 将流量分发给不同的 Web 服务进程。

### Web 服务：Puma

Puma 作为 Rails 应用的容器，接收 Nginx 分发过来的请求，处理后返回响应。

### 数据库：Postgres

存储一切业务需要的数据，比如：用户记录、商品记录、订单...

### 缓存：Redis

Redis 是一个 in-memory 数据库，将数据存储在内存中。通过缓存服务，可以快速返回已生成好的内容。

比如在用户访问资源前，需要检查用户的权限，而当前用户的权限列表需要从访问好几个数据库表才能构建出来，我们可以在第一次检查权限时把构建好的权限列表存到缓存中，然后下次检查权限时，就不必从数据库加载记录了，可以从访问速度快的多的缓存中读取。要注意的是，每次写缓存时，都要考虑在什么条件下进行失效处理。对于权限列表，我们应该在用户权限更改时，将它删除。

### 异步任务：Sidekiq

Sidekiq 是一个基于 Redis 的异步任务服务。我们在请求中将任务保存进 Redis，Sidekiq 服务会不断从 Redis 获取任务，然后处理。对于一些我们不关心其返回结果或者比较耗时的操作，我们可以异步处理这些操作。

比如用户注册成功后，系统会发一封欢迎邮件给该用户，发送邮件这个操作不必在注册接口中执行，不必阻塞用户的注册动作。

### 消息队列：Active Mq

消息队列有许多好处：平衡流量高峰、解耦。消息列队有 2 个角色：发布者、消费者。他们不关心消息从哪里来，到哪里去，只关心消息内容，从而达到解耦的目的。

比如 A 系统修改房间状态后发布了一条消息出去，B 系统收到这条消息，它再根据内容做其他事情，这个过程中，A 不用担心有哪些系统要监听这个消息，也不必关心消息是否被成功处理。

作为消费者，需要启动一个进程来专门接收消息，Ruby 应用可以使用 [Stomp](https://github.com/stompgem/stomp) 作为 ActiveMq 的消费者。

### 搜索引擎：ElasticSearch

使用 ES，我们可以实现实时查询、聚合数据、全文搜索。

### CDN

存储静态资源文件，比如图片、JS脚本、HTML、CSS等等。使用 CDN 服务，可以让用户更快的访问资源，而且将流量不用经过我们的 Web 服务器。